<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>How PrefixContext and ConditionContext interact · DynamicPPL</title><meta name="title" content="How PrefixContext and ConditionContext interact · DynamicPPL"/><meta property="og:title" content="How PrefixContext and ConditionContext interact · DynamicPPL"/><meta property="twitter:title" content="How PrefixContext and ConditionContext interact · DynamicPPL"/><meta name="description" content="Documentation for DynamicPPL."/><meta property="og:description" content="Documentation for DynamicPPL."/><meta property="twitter:description" content="Documentation for DynamicPPL."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body>
<!-- NAVBAR START -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap');

    /* Documenter.jl CSS Overrides */
    html {
        scroll-padding-top: calc(var(--navbar-height) + 1rem);
    }
    .docs-sidebar, #documenter {
        margin-top: var(--navbar-height);
    }
    .docs-version-selector {
        margin-bottom: 60px !important;
    }
    @media screen and (max-width: 1056px) {
        .docs-version-selector {
            margin-bottom: 60px !important;
        }
        .docs-sidebar {
            margin-top: 0 !important;
        }
    }
    /* End of Documenter.jl Tweaks */

    /* Color and Font Variables */
    :root {
        --heading-color: #6c757d;
        --item-color: rgb(165, 165, 165);
        --primary-bg: white;
        --hover-color: #8faad2;
        --deprecated-bg: #ff4d4d;
        --deprecated-text: white;
        --icon-color: #6c757d;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --dropdown-hover-bg: #e9ecef;
        
        /* Typography */
        --font-family: "Source Sans Pro", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        --nav-link-font-size: 1.0625rem;
        --turing-title-font-size: 21.25px;
        --icon-font-size: 1.25rem;
        --dropdown-arrow-font-size: 0.6875rem;
        --badge-font-size: 0.75rem;

        /* Sizing and Spacing */
        --navbar-height: 3.75rem;
        --logo-height: 31px;
        --logo-width: auto;
        --logo-padding-top: 7px;
        --logo-margin-left: 0.8rem;
        --title-margin-left: 0.4px;
        --title-nav-spacing: 1.1rem;
        --nav-item-margin-left: 1.3rem;
        --icon-margin-left: 1rem;
        --dropdown-padding: 1.875rem;
        --dropdown-item-width: 12.5rem;
        --dropdown-subitem-width: 15.625rem;
        --dropdown-subitem-padding: 0.125rem 0.625rem;
    }

    /* Dark Theme Variable Overrides */
    html.theme--documenter-dark {
        --heading-color: #e0e0e0;
        --item-color: #bdbdbd;
        --primary-bg: #1f2424;
        --hover-color: #ffffff;
        --icon-color: #e0e0e0;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #424242;
    }

    /* Catppuccin Theme Overrides */
    html.theme--catppuccin-latte {
        --heading-color: #4c4f69;
        --primary-bg: #eff1f5;
        --icon-color: #4c4f69;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --dropdown-hover-bg: #e6e9ef;
    }
    html.theme--catppuccin-frappe {
        --heading-color: #c6d0f5;
        --primary-bg: #303446;
        --icon-color: #c6d0f5;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #51576d;
    }
    html.theme--catppuccin-macchiato {
        --heading-color: #cad3f5;
        --primary-bg: #24273a;
        --icon-color: #cad3f5;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #494d64;
    }
    html.theme--catppuccin-mocha {
        --heading-color: #cad3f5;
        --primary-bg: #1e1e2e;
        --icon-color: #cad3f5;
        --shadow-color: rgba(255, 255, 255, 0.1);
        --dropdown-hover-bg: #45475a;
    }


    /* Main Navigation Bar */
    .ext-navigation {
        font-family: var(--font-family);
        position: fixed;
        height: var(--navbar-height);
        top: 0;
        width: 100%;
        background-color: var(--primary-bg);
        z-index: 1000;
        box-shadow: 0 2px 4px var(--shadow-color);
        display: flex;
        align-items: center;
        padding: 0 1.0625rem;
        transition: transform 0.3s, background-color 0.3s;
    }

    nav.ext-navigation .ext-navbar-logo {
        margin-left: var(--logo-margin-left);
        height: auto;
        max-height: var(--logo-height);
        width: auto;
        padding-top: var(--logo-padding-top);
    }
    
    /* Theme-aware logo text color */
    .ext-navbar-logo .logo-text {
        fill: var(--heading-color);
    }
    
    .ext-navbar-title {
        color: var(--heading-color) !important;
        font-size: var(--turing-title-font-size) !important;
        margin-left: var(--title-margin-left);
        text-decoration: none;
        transition: color 0.2s ease;
    }
    
    .ext-navbar-title:hover {
        color: var(--hover-color) !important;
    }

    .ext-nav-links {
        display: flex;
        align-items: center;
        list-style-type: none;
        margin: 0;
        padding: 0;
        flex-grow: 1;
        margin-left: var(--title-nav-spacing);
    }

    .ext-nav-links li:first-child {
        margin-left: 0 !important;
    }

    .ext-nav-links li {
        margin-left: var(--nav-item-margin-left) !important;
    }

    .ext-nav-link {
        color: var(--heading-color) !important;
        text-decoration: none;
        font-size: var(--nav-link-font-size) !important;
        transition: color 0.2s ease;
        cursor: pointer;
    }

    .ext-nav-link:hover,
    .ext-navbar-item-single a:hover,
    .ext-navbar-icons a:hover {
        color: var(--hover-color) !important;
    }

    .ext-navbar-item-single a {
        color: var(--heading-color) !important;
    }
    
    .ext-navbar-icons {
        display: flex;
        align-items: center;
    }

    .ext-navbar-icons a {
        color: var(--icon-color) !important;
        font-size: var(--icon-font-size) !important;
        transition: color 0.2s ease;
        margin-left: var(--icon-margin-left);
    }

    .ext-menu-toggle {
        display: none;
        font-size: 1.5rem;
        color: var(--heading-color);
        cursor: pointer;
    }

    .ext-dropdown {
        display: none;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        padding: var(--dropdown-padding);
        position: absolute;
        top: var(--navbar-height);
        width: 100%;
        left: 0;
        background-color: var(--primary-bg);
        line-height: 1.875rem;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, background-color 0.3s;
        transform: translateY(-0.625rem);
        box-shadow: 0 4px 6px var(--shadow-color);
    }

    #library-handler::after {
        content: "▼";
        font-size: var(--dropdown-arrow-font-size);
        margin-left: 0.3125rem;
        transition: transform 0.3s ease-in-out;
    }

    #library-handler.open::after {
        content: "▲";
    }

    .ext-dropdown.show {
        display: grid;
        opacity: 1;
        transform: translateY(0);
    }

    .ext-dropdown ul {
        width: var(--dropdown-item-width);
        margin-bottom: 1.25rem;
    }

    .ext-dropdown ul li {
        text-align: left;
        display: flex;
        align-items: center;
    }

    .ext-dropdown ul a li {
        color: var(--item-color);
        width: var(--dropdown-subitem-width);
        border-radius: 3px;
        padding: var(--dropdown-subitem-padding);
        transition: background-color 0.2s ease;
    }

    .ext-dropdown ul a li:hover {
        background-color: var(--dropdown-hover-bg);
    }

    .ext-dropdown-item-heading {
        color: var(--heading-color);
        text-align: center;
    }

    .deprecated-badge {
        background-color: var(--deprecated-bg);
        color: var(--deprecated-text);
        font-size: var(--badge-font-size);
        padding: .1rem;
        border-radius: 3px;
        margin-left: 0.5rem;
        line-height: 1;
    }

    @media (max-width: 966px) {
        .ext-dropdown {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .ext-nav-links {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background-color: var(--primary-bg);
            position: absolute;
            top: var(--navbar-height);
            left: 0;
            padding: 0.625rem 0;
            height: auto;
            overflow-y: auto;
            box-shadow: 0 4px 6px var(--shadow-color);
            margin-left: 0;
        }

        .ext-nav-links.show {
            display: flex;
        }

        .ext-nav-links li {
            margin: 0.625rem 0 !important;
            text-align: center;
        }
        
        .ext-menu-toggle {
            display: block;
            margin-left: auto;
        }

        .ext-navigation.hide {
            transform: translateY(calc(-1 * var(--navbar-height)));
        }

        .ext-dropdown {
            position: static;
            display: block;
            opacity: 1;
            transform: none;
            box-shadow: none;
            grid-template-columns: 1fr;
            padding: 0.625rem;
            text-align: center;
        }

        .ext-dropdown ul {
            width: auto;
            display: inline-block;
            margin: 0 auto 0.3125rem;
            text-align: left;
        }
    }
</style>
<nav class="ext-navigation">
    <a href="https://turinglang.org/">
        <svg width="4333" height="1145" viewBox="0 0 4333 1145" fill="none" xmlns="http://www.w3.org/2000/svg" class="ext-navbar-logo">
            <path class="logo-text" d="M0.44603 193.181V66.9868H663.471V193.181H406.62V898H257.297V193.181H0.44603ZM1097.24 635.874V274.74H1244.13V898H1101.7V787.225H1095.21C1081.14 822.121 1058.01 850.66 1025.82 872.842C993.902 895.024 954.542 906.115 907.744 906.115C866.896 906.115 830.783 897.053 799.403 878.929C768.295 860.534 743.948 833.889 726.365 798.993C708.782 763.826 699.99 721.356 699.99 671.581V274.74H846.878V648.858C846.878 688.353 857.699 719.733 879.34 742.997C900.981 766.261 929.385 777.893 964.551 777.893C986.192 777.893 1007.16 772.618 1027.45 762.068C1047.73 751.518 1064.37 735.828 1077.35 714.999C1090.61 693.899 1097.24 667.524 1097.24 635.874ZM1395.17 898V274.74H1537.6V378.617H1544.09C1555.45 342.639 1574.93 314.911 1602.52 295.434C1630.38 275.687 1662.17 265.813 1697.88 265.813C1705.99 265.813 1715.05 266.219 1725.06 267.031C1735.34 267.572 1743.86 268.518 1750.63 269.871V404.992C1744.4 402.828 1734.53 400.934 1721 399.311C1707.75 397.417 1694.9 396.471 1682.46 396.471C1655.68 396.471 1631.6 402.287 1610.23 413.919C1589.13 425.28 1572.49 441.105 1560.32 461.393C1548.15 481.682 1542.06 505.081 1542.06 531.591V898H1395.17ZM1848.21 898V274.74H1995.1V898H1848.21ZM1922.06 186.283C1898.8 186.283 1878.78 178.573 1862.01 163.154C1845.24 147.464 1836.85 128.664 1836.85 106.752C1836.85 84.5701 1845.24 65.7695 1862.01 50.3503C1878.78 34.6606 1898.8 26.8158 1922.06 26.8158C1945.6 26.8158 1965.61 34.6606 1982.12 50.3503C1998.89 65.7695 2007.27 84.5701 2007.27 106.752C2007.27 128.664 1998.89 147.464 1982.12 163.154C1965.61 178.573 1945.6 186.283 1922.06 186.283ZM2293.04 532.809V898H2146.15V274.74H2286.54V380.646H2293.85C2308.18 345.75 2331.04 318.022 2362.42 297.463C2394.07 276.904 2433.16 266.625 2479.69 266.625C2522.7 266.625 2560.17 275.822 2592.09 294.217C2624.28 312.612 2649.17 339.257 2666.75 374.153C2684.6 409.049 2693.39 451.385 2693.12 501.159V898H2546.24V523.882C2546.24 482.223 2535.41 449.626 2513.77 426.092C2492.4 402.557 2462.78 390.79 2424.91 390.79C2399.21 390.79 2376.35 396.471 2356.34 407.832C2336.59 418.923 2321.03 435.019 2309.67 456.119C2298.58 477.218 2293.04 502.782 2293.04 532.809ZM3113.5 1144.71C3060.75 1144.71 3015.44 1137.54 2977.57 1123.2C2939.7 1109.13 2909.26 1090.2 2886.27 1066.39C2863.28 1042.59 2847.32 1016.21 2838.39 987.269L2970.67 955.213C2976.62 967.386 2985.28 979.424 2996.64 991.327C3008 1003.5 3023.28 1013.51 3042.49 1021.35C3061.97 1029.47 3086.45 1033.53 3115.93 1033.53C3157.59 1033.53 3192.08 1023.38 3219.4 1003.09C3246.73 983.076 3260.39 950.074 3260.39 904.087V786.008H3253.08C3245.51 801.157 3234.42 816.711 3219.81 832.671C3205.47 848.632 3186.4 862.022 3162.6 872.842C3139.06 883.663 3109.44 889.073 3073.73 889.073C3025.85 889.073 2982.44 877.847 2943.48 855.394C2904.8 832.671 2873.96 798.857 2850.97 753.952C2828.24 708.777 2816.88 652.24 2816.88 584.341C2816.88 515.902 2828.24 458.147 2850.97 411.078C2873.96 363.739 2904.93 327.896 2943.89 303.55C2982.84 278.933 3026.26 266.625 3074.14 266.625C3110.66 266.625 3140.69 272.847 3164.22 285.29C3188.03 297.463 3206.96 312.206 3221.03 329.519C3235.09 346.561 3245.78 362.657 3253.08 377.805H3261.2V274.74H3406.06V908.144C3406.06 961.435 3393.34 1005.53 3367.92 1040.42C3342.49 1075.32 3307.73 1101.43 3263.63 1118.74C3219.54 1136.05 3169.5 1144.71 3113.5 1144.71ZM3114.72 773.835C3145.83 773.835 3172.34 766.261 3194.25 751.112C3216.16 735.963 3232.79 714.187 3244.16 685.783C3255.52 657.379 3261.2 623.295 3261.2 583.53C3261.2 544.305 3255.52 509.95 3244.16 480.465C3233.07 450.979 3216.56 428.12 3194.65 411.89C3173.01 395.389 3146.37 387.138 3114.72 387.138C3081.98 387.138 3054.66 395.659 3032.75 412.701C3010.84 429.744 2994.34 453.143 2983.25 482.899C2972.16 512.385 2966.61 545.929 2966.61 583.53C2966.61 621.672 2972.16 655.08 2983.25 683.754C2994.61 712.158 3011.25 734.34 3033.16 750.3C3055.34 765.99 3082.53 773.835 3114.72 773.835ZM3647.08 906.927C3622.47 906.927 3601.37 898.271 3583.78 880.958C3566.2 863.645 3557.54 842.545 3557.82 817.658C3557.54 793.312 3566.2 772.482 3583.78 755.17C3601.37 737.857 3622.47 729.2 3647.08 729.2C3670.89 729.2 3691.58 737.857 3709.17 755.17C3727.02 772.482 3736.08 793.312 3736.35 817.658C3736.08 834.159 3731.75 849.173 3723.37 862.698C3715.25 876.224 3704.43 887.044 3690.91 895.16C3677.65 903.004 3663.04 906.927 3647.08 906.927ZM3888.01 274.74H4034.9V933.708C4034.9 978.613 4026.38 1015.67 4009.33 1044.89C3992.29 1074.1 3967.67 1095.88 3935.48 1110.22C3903.29 1124.55 3864.2 1131.72 3818.22 1131.72C3812.81 1131.72 3807.8 1131.59 3803.2 1131.32C3798.6 1131.32 3793.6 1131.18 3788.19 1130.91V1011.21C3792.25 1011.48 3795.9 1011.62 3799.15 1011.62C3802.39 1011.89 3805.77 1012.02 3809.29 1012.02C3837.42 1012.02 3857.58 1005.12 3869.75 991.327C3881.92 977.801 3888.01 957.918 3888.01 931.679V274.74ZM3961.05 186.283C3937.51 186.283 3917.36 178.573 3900.59 163.154C3884.09 147.464 3875.84 128.664 3875.84 106.752C3875.84 84.5701 3884.09 65.7695 3900.59 50.3503C3917.36 34.6606 3937.51 26.8158 3961.05 26.8158C3984.31 26.8158 4004.19 34.6606 4020.7 50.3503C4037.47 65.7695 4045.85 84.5701 4045.85 106.752C4045.85 128.664 4037.47 147.464 4020.7 163.154C4004.19 178.573 3984.31 186.283 3961.05 186.283ZM4332.83 66.9868V898H4185.94V66.9868H4332.83Z" fill="currentColor"/>
            <path d="M4076 108.5C4076 168.424 4027.42 217 3967.5 217C3907.58 217 3859 168.424 3859 108.5C3859 48.5762 3907.58 0 3967.5 0C4027.42 0 4076 48.5762 4076 108.5Z" fill="#389725"/>
            <path d="M3755 814.5C3755 874.424 3706.42 923 3646.5 923C3586.58 923 3538 874.424 3538 814.5C3538 754.576 3586.58 706 3646.5 706C3706.42 706 3755 754.576 3755 814.5Z" fill="#9457B1"/>
            <path d="M2030 108.5C2030 168.424 1981.42 217 1921.5 217C1861.58 217 1813 168.424 1813 108.5C1813 48.5762 1861.58 0 1921.5 0C1981.42 0 2030 48.5762 2030 108.5Z" fill="#CA3B33"/>
        </svg>
    </a>
    <!-- <a class="ext-navbar-title" href="https://turinglang.org/">Turing.jl</a> -->
    
    <ul class="ext-nav-links">
        <li><a class="ext-nav-link" href="https://turinglang.org/docs/getting-started/">Get Started</a></li>
        <li><a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/">Tutorials</a></li>
        <li><a class="ext-nav-link" href="https://turinglang.org/docs/faq/">FAQ</a></li>
        <li>
            <p class="ext-nav-link" id="library-handler">Libraries</p>
            <div class="ext-dropdown" id="ext-dropdown-items">
                <ul>
                    <li class="ext-dropdown-item-heading">Modelling Languages</li>
                    <a href="https://turinglang.org/DynamicPPL.jl/"><li>DynamicPPL</li></a>
                    <a href="https://turinglang.org/JuliaBUGS.jl/"><li>JuliaBUGS</li></a>
                    <a href="https://turinglang.org/TuringGLM.jl/"><li>TuringGLM</li></a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">MCMC</li>
                    <a href="https://turinglang.org/AdvancedHMC.jl/"><li>AdvancedHMC</li></a>
                    <a href="https://turinglang.org/AbstractMCMC.jl/"><li>AbstractMCMC</li></a>
                    <a href="https://github.com/theogf/ThermodynamicIntegration.jl"><li>ThermodynamicIntegration</li></a>
                    <a href="https://turinglang.org/AdvancedPS.jl/"><li>AdvancedPS</li></a>
                    <a href="https://turinglang.org/SliceSampling.jl/"><li>SliceSampling</li></a>
                    <a href="https://turinglang.org/EllipticalSliceSampling.jl/"><li>EllipticalSliceSampling</li></a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Diagnostics</li>
                    <a href="https://turinglang.org/MCMCChains.jl/"><li>MCMCChains</li></a>
                    <a href="https://turinglang.org/MCMCDiagnosticTools.jl/"><li>MCMCDiagnosticTools</li></a>
                    <a href="https://chalk-lab.github.io/ParetoSmooth.jl/"><li>ParetoSmooth</li></a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Gaussian Processes</li>
                    <a href="https://juliagaussianprocesses.github.io/AbstractGPs.jl/"><li>AbstractGPs</li></a>
                    <a href="https://juliagaussianprocesses.github.io/KernelFunctions.jl/"><li>KernelFunctions</li></a>
                    <a href="https://juliagaussianprocesses.github.io/ApproximateGPs.jl/"><li>ApproximateGPs</li></a>
                </ul>
                <ul><li class="ext-dropdown-item-heading ext-navbar-item-single"><a href="https://turinglang.org/Bijectors.jl/">Bijectors</a></li></ul>
                <ul><li class="ext-dropdown-item-heading ext-navbar-item-single"><a href="https://turinglang.org/TuringCallbacks.jl/">TuringCallbacks</a></li></ul>
                <ul><li class="ext-dropdown-item-heading ext-navbar-item-single"><a href="https://turinglang.org/Deprecated/TuringBenchmarking/">TuringBenchmarking</a><span class="deprecated-badge">Deprecated</span></li></ul>
            </div>
        </li>
        <li><a class="ext-nav-link" href="https://turinglang.org/news/">News</a></li>
        <li><a class="ext-nav-link" href="https://turinglang.org/team/">Team</a></li>
    </ul>

    <div class="ext-navbar-icons">
        <a href="https://x.com/TuringLang" aria-label="Turing on X"><i class="fa-brands fa-x-twitter"></i></a>
        <a href="https://discourse.julialang.org/c/domain/probprog/48" aria-label="Turing on Discourse"><i class="fa-brands fa-discourse"></i></a>
        <a href="https://julialang.slack.com/archives/CCYDC34A0" aria-label="Turing on Slack"><i class="fa-brands fa-slack"></i></a>
        <a href="https://github.com/TuringLang/" aria-label="Turing.jl on GitHub"><i class="fa-brands fa-github"></i></a>
    </div>

    <span class="ext-menu-toggle"><i class="fa-solid fa-bars"></i></span>
</nav>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const menuToggle = document.querySelector(".ext-menu-toggle");
        const navLinks = document.querySelector(".ext-nav-links");
        const nav = document.querySelector(".ext-navigation");
        const libraryHandler = document.getElementById("library-handler");
        const dropdownContainer = document.getElementById("ext-dropdown-items");
        let lastScrollY = window.scrollY;

        function closeDropdown() {
            if (dropdownContainer.classList.contains("show")) {
                libraryHandler.classList.remove("open");
                dropdownContainer.classList.remove("show");
                setTimeout(() => {
                    if (!dropdownContainer.classList.contains("show")) {
                        dropdownContainer.style.display = "none";
                    }
                }, 300);
            }
        }

        function openDropdown() {
            dropdownContainer.style.display = "grid";
            libraryHandler.classList.add("open");
            setTimeout(() => {
                dropdownContainer.classList.add("show");
            }, 10);
        }

        function setAppropriateHeight() {
            if (window.innerWidth <= 768) {
                const viewportHeight = window.innerHeight;
                const navHeight = nav.offsetHeight;
                navLinks.style.maxHeight = `${viewportHeight - navHeight}px`;
                navLinks.style.overflowY = "auto";
            } else {
                navLinks.style.maxHeight = "";
                navLinks.style.overflowY = "";
            }
        }

        menuToggle.addEventListener("click", (event) => {
            event.stopPropagation();
            navLinks.classList.toggle("show");
            if (navLinks.classList.contains("show")) {
                setAppropriateHeight();
                closeDropdown();
                dropdownContainer.style.display = "none";
            }
        });

        libraryHandler.addEventListener("click", (event) => {
            event.stopPropagation();
            event.preventDefault();
            if (dropdownContainer.classList.contains("show")) {
                closeDropdown();
            } else {
                openDropdown();
            }
            setAppropriateHeight();
        });

        // Close all menus if a click is registered outside the navigation bar.
        document.addEventListener("click", (event) => {
            if (!nav.contains(event.target)) {
                navLinks.classList.remove("show");
                closeDropdown();
            }
        });

        // Hide navigation bar on scroll down in mobile view.
        window.addEventListener("scroll", () => {
            if (window.innerWidth <= 768) {
                if (window.scrollY > lastScrollY && window.scrollY > nav.offsetHeight){
                    nav.classList.add("hide");
                } else {
                    nav.classList.remove("hide");
                }
                lastScrollY = window.scrollY;
            }
        });

        window.addEventListener("resize", setAppropriateHeight);
    });
</script>
<!-- NAVBAR END -->



<div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="DynamicPPL logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">DynamicPPL</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../api/">API</a></li><li><span class="tocitem">Internals</span><ul><li><a class="tocitem" href="../varinfo/">Design of <code>VarInfo</code></a></li><li class="is-active"><a class="tocitem" href>How <code>PrefixContext</code> and <code>ConditionContext</code> interact</a><ul class="internal"><li><a class="tocitem" href="#PrefixContext"><span>PrefixContext</span></a></li><li><a class="tocitem" href="#ConditionContext"><span>ConditionContext</span></a></li><li><a class="tocitem" href="#Joint-behaviour:-desiderata-at-the-model-level"><span>Joint behaviour: desiderata at the model level</span></a></li><li><a class="tocitem" href="#Desiderata-at-the-context-level"><span>Desiderata at the context level</span></a></li><li><a class="tocitem" href="#How-do-we-do-it?"><span>How do we do it?</span></a></li><li><a class="tocitem" href="#Nested-submodels"><span>Nested submodels</span></a></li><li><a class="tocitem" href="#Loose-ends-1:-Manual-prefixing"><span>Loose ends 1: Manual prefixing</span></a></li><li><a class="tocitem" href="#Loose-ends-2:-FixedContext"><span>Loose ends 2: FixedContext</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Internals</a></li><li class="is-active"><a href>How <code>PrefixContext</code> and <code>ConditionContext</code> interact</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>How <code>PrefixContext</code> and <code>ConditionContext</code> interact</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TuringLang/DynamicPPL.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/TuringLang/DynamicPPL.jl/blob/main/docs/src/internals/submodel_condition.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="How-PrefixContext-and-ConditionContext-interact"><a class="docs-heading-anchor" href="#How-PrefixContext-and-ConditionContext-interact">How <code>PrefixContext</code> and <code>ConditionContext</code> interact</a><a id="How-PrefixContext-and-ConditionContext-interact-1"></a><a class="docs-heading-anchor-permalink" href="#How-PrefixContext-and-ConditionContext-interact" title="Permalink"></a></h1><h2 id="PrefixContext"><a class="docs-heading-anchor" href="#PrefixContext">PrefixContext</a><a id="PrefixContext-1"></a><a class="docs-heading-anchor-permalink" href="#PrefixContext" title="Permalink"></a></h2><p><code>PrefixContext</code> is a context that, as the name suggests, prefixes all variables inside a model with a given symbol. Thus, for example:</p><pre><code class="language-julia hljs">using DynamicPPL, Distributions

@model function f()
    x ~ Normal()
    return y ~ Normal()
end

@model function g()
    return a ~ to_submodel(f())
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">g (generic function with 2 methods)</code></pre><p>inside the submodel <code>f</code>, the variables <code>x</code> and <code>y</code> become <code>a.x</code> and <code>a.y</code> respectively. This is easiest to observe by running the model:</p><pre><code class="language-julia hljs">vi = VarInfo(g())
keys(vi)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{VarName{:a}}:
 a.x
 a.y</code></pre><div class="admonition is-info" id="Note-2c82ebdcebac0237"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-2c82ebdcebac0237" title="Permalink"></a></header><div class="admonition-body"><p>In this case, where <code>to_submodel</code> is called without any other arguments, the prefix to be used is automatically inferred from the name of the variable on the left-hand side of the tilde. We will return to the &#39;manual prefixing&#39; case later.</p></div></div><p>The phrase &#39;becoming&#39; a different variable is a little underspecified: it is useful to pinpoint the exact location where the prefixing occurs, which is <code>tilde_assume</code>. The method responsible for it is <code>tilde_assume(::PrefixContext, right, vn, vi)</code>: this attaches the prefix in the context to the <code>VarName</code> argument, before recursively calling <code>tilde_assume</code> with the new prefixed <code>VarName</code>. This means that even though a statement <code>x ~ dist</code> still enters the tilde pipeline at the top level as <code>x</code>, if the model evaluation context contains a <code>PrefixContext</code>, any function from <code>tilde_assume</code> onwards will see <code>a.x</code> instead.</p><h2 id="ConditionContext"><a class="docs-heading-anchor" href="#ConditionContext">ConditionContext</a><a id="ConditionContext-1"></a><a class="docs-heading-anchor-permalink" href="#ConditionContext" title="Permalink"></a></h2><p><code>ConditionContext</code> is a context which stores values of variables that are to be conditioned on. These values may be stored as a <code>Dict</code> which maps <code>VarName</code>s to values, or alternatively as a <code>NamedTuple</code>. The latter only works correctly if all <code>VarName</code>s are &#39;basic&#39;, in that they have an identity optic (i.e., something like <code>a.x</code> or <code>a[1]</code> is forbidden). Because of this limitation, we will only use <code>Dict</code> in this example.</p><div class="admonition is-info" id="Note-812be9c171257dbd"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-812be9c171257dbd" title="Permalink"></a></header><div class="admonition-body"><p>If a <code>ConditionContext</code> with a <code>NamedTuple</code> encounters anything to do with a prefix, its internal <code>NamedTuple</code> is converted to a <code>Dict</code> anyway, so it is quite reasonable to ignore the <code>NamedTuple</code> case in this exposition.</p></div></div><p>One can inspect the conditioning values with, for example:</p><pre><code class="language-julia hljs">@model function d()
    x ~ Normal()
    return y ~ Normal()
end

cond_model = d() | (@varname(x) =&gt; 1.0)
cond_ctx = cond_model.context</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ConditionContext(Dict(x =&gt; 1.0), DefaultContext())</code></pre><p>There are several internal functions that are used to determine whether a variable is conditioned, and if so, what its value is.</p><pre><code class="language-julia hljs">DynamicPPL.hasconditioned_nested(cond_ctx, @varname(x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><pre><code class="language-julia hljs">DynamicPPL.getconditioned_nested(cond_ctx, @varname(x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1.0</code></pre><p>These functions are in turn used by the function <code>DynamicPPL.contextual_isassumption</code>, which is largely the same as <code>hasconditioned_nested</code>, but also checks whether the value is <code>missing</code> (in which case it isn&#39;t really conditioned).</p><pre><code class="language-julia hljs">DynamicPPL.contextual_isassumption(cond_ctx, @varname(x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">false</code></pre><div class="admonition is-info" id="Note-b8513a8f228559a1"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-b8513a8f228559a1" title="Permalink"></a></header><div class="admonition-body"><p>Notice that (neglecting <code>missing</code> values) the return value of <code>contextual_isassumption</code> is the <em>opposite</em> of <code>hasconditioned_nested</code>, i.e. for a variable that <em>is</em> conditioned on, <code>contextual_isassumption</code> returns <code>false</code>.</p></div></div><p>If a variable <code>x</code> is conditioned on, then the effect of this is to set the value of <code>x</code> to the given value (while still including its contribution to the log probability density). Since <code>x</code> is no longer a random variable, if we were to evaluate the model, we would find only one key in the <code>VarInfo</code>:</p><pre><code class="language-julia hljs">keys(VarInfo(cond_model))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1-element Vector{VarName{:y, typeof(identity)}}:
 y</code></pre><h2 id="Joint-behaviour:-desiderata-at-the-model-level"><a class="docs-heading-anchor" href="#Joint-behaviour:-desiderata-at-the-model-level">Joint behaviour: desiderata at the model level</a><a id="Joint-behaviour:-desiderata-at-the-model-level-1"></a><a class="docs-heading-anchor-permalink" href="#Joint-behaviour:-desiderata-at-the-model-level" title="Permalink"></a></h2><p>When paired together, these two contexts have the potential to cause substantial confusion: <code>PrefixContext</code> modifies the variable names that are seen, which may cause them to be out of sync with the values contained inside the <code>ConditionContext</code>.</p><p>We begin by mentioning some high-level desiderata for their joint behaviour. Take these models, for example:</p><pre><code class="language-julia hljs"># We define a helper function to unwrap a layer of SamplingContext, to
# avoid cluttering the print statements.
unwrap_sampling_context(ctx::DynamicPPL.SamplingContext) = ctx.context
unwrap_sampling_context(ctx::DynamicPPL.AbstractContext) = ctx
@model function inner()
    println(&quot;inner context: $(unwrap_sampling_context(__context__))&quot;)
    x ~ Normal()
    return y ~ Normal()
end

@model function outer()
    println(&quot;outer context: $(unwrap_sampling_context(__context__))&quot;)
    return a ~ to_submodel(inner())
end

# &#39;Outer conditioning&#39;
with_outer_cond = outer() | (@varname(a.x) =&gt; 1.0)

# &#39;Inner conditioning&#39;
inner_cond = inner() | (@varname(x) =&gt; 1.0)
@model function outer2()
    println(&quot;outer context: $(unwrap_sampling_context(__context__))&quot;)
    return a ~ to_submodel(inner_cond)
end
with_inner_cond = outer2()</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Model{typeof(Main.outer2), (), (), (), Tuple{}, Tuple{}, DefaultContext}(Main.outer2, NamedTuple(), NamedTuple(), DefaultContext())</code></pre><p>We want that:</p><ol><li><code>keys(VarInfo(outer()))</code> should return <code>[a.x, a.y]</code>;</li><li><code>keys(VarInfo(with_outer_cond))</code> should return <code>[a.y]</code>;</li><li><code>keys(VarInfo(with_inner_cond))</code> should return <code>[a.y]</code>,</li></ol><p><strong>In other words, we can condition submodels either from the outside (point (2)) or from the inside (point (3)), and the variable name we use to specify the conditioning should match the level at which we perform the conditioning.</strong></p><p>This is an incredibly salient point because it means that submodels can be treated as individual, opaque objects, and we can condition them without needing to know what it will be prefixed with, or the context in which that submodel is being used. For example, this means we can reuse <code>inner_cond</code> in another model with a different prefix, and it will <em>still</em> have its inner <code>x</code> value be conditioned, despite the prefix differing.</p><div class="admonition is-info" id="Info-a1b5114c76507999"><header class="admonition-header">Info<a class="admonition-anchor" href="#Info-a1b5114c76507999" title="Permalink"></a></header><div class="admonition-body"><p>In the current version of DynamicPPL, these criteria are all fulfilled. However, this was not the case in the past: in particular, point (3) was not fulfilled, and users had to condition the internal submodel with the prefixes that were used outside. (See <a href="https://github.com/TuringLang/DynamicPPL.jl/issues/857">this GitHub issue</a> for more information; this issue was the direct motivation for this documentation page.)</p></div></div><h2 id="Desiderata-at-the-context-level"><a class="docs-heading-anchor" href="#Desiderata-at-the-context-level">Desiderata at the context level</a><a id="Desiderata-at-the-context-level-1"></a><a class="docs-heading-anchor-permalink" href="#Desiderata-at-the-context-level" title="Permalink"></a></h2><p>The above section describes how we expect conditioning and prefixing to behave from a user&#39;s perpective. We now turn to the question of how we implement this in terms of DynamicPPL contexts. We do not specify the implementation details here, but we will sketch out something resembling an API that will allow us to achieve the target behaviour.</p><p><strong>Point (1)</strong> does not involve any conditioning, only prefixing; it is therefore already satisfied by virtue of the <code>tilde_assume</code> method shown above.</p><p><strong>Points (2) and (3)</strong> are more tricky. As the reader may surmise, the difference between them is the order in which the contexts are stacked.</p><p>For the <em>outer</em> conditioning case (point (2)), the <code>ConditionContext</code> will contain a <code>VarName</code> that is already prefixed. When we enter the inner submodel, this <code>ConditionContext</code> has to be passed down and somehow combined with the <code>PrefixContext</code> that is created when we enter the submodel. We make the claim here that the best way to do this is to nest the <code>PrefixContext</code> <em>inside</em> the <code>ConditionContext</code>. This is indeed what happens, as can be demonstrated by running the model.</p><pre><code class="language-julia hljs">with_outer_cond();
nothing;</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">outer context: ConditionContext(Dict(a.x =&gt; 1.0), DefaultContext())
inner context: ConditionContext(Dict(a.x =&gt; 1.0), PrefixContext{VarName{:a, typeof(identity)}, DefaultContext}(a, DefaultContext()))</code></pre><div class="admonition is-info" id="Info-411d49eb9614ea1b"><header class="admonition-header">Info<a class="admonition-anchor" href="#Info-411d49eb9614ea1b" title="Permalink"></a></header><div class="admonition-body"><p>The <code>; nothing</code> at the end is purely to circumvent a Documenter.jl quirk where stdout is only shown if the return value of the final statement is <code>nothing</code>. If these documentation pages are moved to Quarto, it will be possible to remove this.</p></div></div><p>For the <em>inner</em> conditioning case (point (3)), the outer model is not run with any special context. The inner model will itself contain a <code>ConditionContext</code> will contain a <code>VarName</code> that is not prefixed. When we run the model, this <code>ConditionContext</code> should be then nested <em>inside</em> a <code>PrefixContext</code> to form the final evaluation context. Again, we can run the model to see this in action:</p><pre><code class="language-julia hljs">with_inner_cond();
nothing;</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">outer context: DefaultContext()
inner context: PrefixContext{VarName{:a, typeof(identity)}, ConditionContext{Dict{VarName{:x, typeof(identity)}, Float64}, DefaultContext}}(a, ConditionContext(Dict(x =&gt; 1.0), DefaultContext()))</code></pre><p>Putting all of the information so far together, what it means is that if we have these two inner contexts (taken from above):</p><pre><code class="language-julia hljs">using DynamicPPL: PrefixContext, ConditionContext, DefaultContext

inner_ctx_with_outer_cond = ConditionContext(
    Dict(@varname(a.x) =&gt; 1.0), PrefixContext(@varname(a))
)
inner_ctx_with_inner_cond = PrefixContext(
    @varname(a), ConditionContext(Dict(@varname(x) =&gt; 1.0))
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">PrefixContext{VarName{:a, typeof(identity)}, ConditionContext{Dict{VarName{:x, typeof(identity)}, Float64}, DefaultContext}}(a, ConditionContext(Dict(x =&gt; 1.0), DefaultContext()))</code></pre><p>then we want both of these to be <code>true</code> (and thankfully, they are!):</p><pre><code class="language-julia hljs">DynamicPPL.hasconditioned_nested(inner_ctx_with_outer_cond, @varname(a.x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><pre><code class="language-julia hljs">DynamicPPL.hasconditioned_nested(inner_ctx_with_inner_cond, @varname(a.x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><p>This allows us to finally specify our task as follows:</p><p>(1) Given the correct arguments, we need to make sure that <code>hasconditioned_nested</code> and <code>getconditioned_nested</code> behave correctly.</p><p>(2) We need to make sure that both the correct arguments are supplied. In order to do so:</p><ul><li><p>(2a) We need to make sure that when evaluating a submodel, the context stack is arranged such that <code>PrefixContext</code> is applied <em>inside</em> the parent model&#39;s context, but <em>outside</em> the submodel&#39;s own context.</p></li><li><p>(2b) We also need to make sure that the <code>VarName</code> passed to it is prefixed correctly.</p></li></ul><h2 id="How-do-we-do-it?"><a class="docs-heading-anchor" href="#How-do-we-do-it?">How do we do it?</a><a id="How-do-we-do-it?-1"></a><a class="docs-heading-anchor-permalink" href="#How-do-we-do-it?" title="Permalink"></a></h2><p>(1) <code>hasconditioned_nested</code> and <code>getconditioned_nested</code> accomplish this by first &#39;collapsing&#39; the context stack, i.e. they go through the context stack, remove all <code>PrefixContext</code>s, and apply those prefixes to any conditioned variables below it in the stack. Once the <code>PrefixContext</code>s have been removed, one can then iterate through the context stack and check if any of the <code>ConditionContext</code>s contain the variable, or get the value itself. For more details the reader is encouraged to read the source code.</p><p>(2a) We ensure that the context stack is correctly arranged by relying on the behaviour of <code>make_evaluate_args_and_kwargs</code>. This function is called whenever a model (which itself contains a context) is evaluated with a separate (&#39;external&#39;) context, and makes sure to arrange both of these contexts such that <em>the model&#39;s context is nested inside the external context</em>. Thus, as long as prefixing is implemented by applying a <code>PrefixContext</code> on the outermost layer of the <em>inner</em> model context, this will be correctly combined with an external context to give the behaviour seen above.</p><p>(2b) At first glance, it seems like <code>tilde_assume</code> can take care of the <code>VarName</code> prefixing for us (as described in the first section). However, this is not actually the case: <code>contextual_isassumption</code>, which is the function that calls <code>hasconditioned_nested</code>, is much higher in the call stack than <code>tilde_assume</code> is. So, we need to explicitly prefix it before passing it to <code>contextual_isassumption</code>. This is done inside the <code>@model</code> macro, or technically, its subsidiary function <code>isassumption</code>.</p><h2 id="Nested-submodels"><a class="docs-heading-anchor" href="#Nested-submodels">Nested submodels</a><a id="Nested-submodels-1"></a><a class="docs-heading-anchor-permalink" href="#Nested-submodels" title="Permalink"></a></h2><p>Just in case the above wasn&#39;t complicated enough, we need to also be very careful when dealing with nested submodels, which have multiple layers of <code>PrefixContext</code>s which may be interspersed with <code>ConditionContext</code>s. For example, in this series of nested submodels,</p><pre><code class="language-julia hljs">@model function charlie()
    x ~ Normal()
    y ~ Normal()
    return z ~ Normal()
end
@model function bravo()
    return b ~ to_submodel(charlie() | (@varname(x) =&gt; 1.0))
end
@model function alpha()
    return a ~ to_submodel(bravo() | (@varname(b.y) =&gt; 1.0))
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">alpha (generic function with 2 methods)</code></pre><p>we expect that the only variable to be sampled should be <code>z</code> inside <code>charlie</code>, or rather, <code>a.b.z</code> once it has been through the prefixes.</p><pre><code class="language-julia hljs">keys(VarInfo(alpha()))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1-element Vector{VarName{:a, ComposedFunction{Accessors.PropertyLens{:z}, Accessors.PropertyLens{:b}}}}:
 a.b.z</code></pre><p>The general strategy that we adopt is similar to above. Following the principle that <code>PrefixContext</code> should be nested inside the outer context, but outside the inner submodel&#39;s context, we can infer that the correct context inside <code>charlie</code> should be:</p><pre><code class="language-julia hljs">big_ctx = PrefixContext(
    @varname(a),
    ConditionContext(
        Dict(@varname(b.y) =&gt; 1.0),
        PrefixContext(@varname(b), ConditionContext(Dict(@varname(x) =&gt; 1.0))),
    ),
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">PrefixContext{VarName{:a, typeof(identity)}, ConditionContext{Dict{VarName{:b, Accessors.PropertyLens{:y}}, Float64}, PrefixContext{VarName{:b, typeof(identity)}, ConditionContext{Dict{VarName{:x, typeof(identity)}, Float64}, DefaultContext}}}}(a, ConditionContext(Dict(b.y =&gt; 1.0), PrefixContext{VarName{:b, typeof(identity)}, ConditionContext{Dict{VarName{:x, typeof(identity)}, Float64}, DefaultContext}}(b, ConditionContext(Dict(x =&gt; 1.0), DefaultContext()))))</code></pre><p>We need several things to work correctly here: we need the <code>VarName</code> prefixing to behave correctly, and then we need to implement <code>hasconditioned_nested</code> and <code>getconditioned_nested</code> on the resulting prefixed <code>VarName</code>. It turns out that the prefixing itself is enough to illustrate the most important point in this section, namely, the need to traverse the context stack in a <em>different direction</em> to what most of DynamicPPL does.</p><p>Let&#39;s work with a function called <code>myprefix(::AbstractContext, ::VarName)</code> (to avoid confusion with any existing DynamicPPL function). We should like <code>myprefix(big_ctx, @varname(x))</code> to return <code>@varname(a.b.x)</code>. Consider the following naive implementation, which mirrors a lot of code in the tilde-pipeline:</p><pre><code class="language-julia hljs">using DynamicPPL: NodeTrait, IsLeaf, IsParent, childcontext, AbstractContext
using AbstractPPL: AbstractPPL

function myprefix(ctx::DynamicPPL.AbstractContext, vn::VarName)
    return myprefix(NodeTrait(ctx), ctx, vn)
end
function myprefix(::IsLeaf, ::AbstractContext, vn::VarName)
    return vn
end
function myprefix(::IsParent, ctx::AbstractContext, vn::VarName)
    return myprefix(childcontext(ctx), vn)
end
function myprefix(ctx::DynamicPPL.PrefixContext, vn::VarName)
    # The functionality to actually manipulate the VarNames is in AbstractPPL
    new_vn = AbstractPPL.prefix(vn, ctx.vn_prefix)
    # Then pass to the child context
    return myprefix(childcontext(ctx), new_vn)
end

myprefix(big_ctx, @varname(x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">b.a.x</code></pre><p>This implementation clearly is not correct, because it applies the <em>inner</em> <code>PrefixContext</code> before the outer one.</p><p>The right way to implement <code>myprefix</code> is to, essentially, reverse the order of two lines above:</p><pre><code class="language-julia hljs">function myprefix(ctx::DynamicPPL.PrefixContext, vn::VarName)
    # Pass to the child context first
    new_vn = myprefix(childcontext(ctx), vn)
    # Then apply this context&#39;s prefix
    return AbstractPPL.prefix(new_vn, ctx.vn_prefix)
end

myprefix(big_ctx, @varname(x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">a.b.x</code></pre><p>This is a much better result! The implementation of related functions such as <code>hasconditioned_nested</code> and <code>getconditioned_nested</code>, under the hood, use a similar recursion scheme, so you will find that this is a common pattern when reading the source code of various prefixing-related functions. When editing this code, it is worth being mindful of this as a potential source of incorrectness.</p><div class="admonition is-info" id="Info-8ca668c916b5c332"><header class="admonition-header">Info<a class="admonition-anchor" href="#Info-8ca668c916b5c332" title="Permalink"></a></header><div class="admonition-body"><p>If you have encountered left and right folds, the above discussion illustrates the difference between them: the wrong implementation of <code>myprefix</code> uses a left fold (which collects prefixes in the opposite order from which they are encountered), while the correct implementation uses a right fold.</p></div></div><h2 id="Loose-ends-1:-Manual-prefixing"><a class="docs-heading-anchor" href="#Loose-ends-1:-Manual-prefixing">Loose ends 1: Manual prefixing</a><a id="Loose-ends-1:-Manual-prefixing-1"></a><a class="docs-heading-anchor-permalink" href="#Loose-ends-1:-Manual-prefixing" title="Permalink"></a></h2><p>Sometimes users may want to manually prefix a model, for example:</p><pre><code class="language-julia hljs">@model function inner_manual()
    x ~ Normal()
    return y ~ Normal()
end

@model function outer_manual()
    return _unused ~ to_submodel(prefix(inner_manual(), :a), false)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">outer_manual (generic function with 2 methods)</code></pre><p>In this case, the <code>VarName</code> on the left-hand side of the tilde is not used, and the prefix is instead specified using the <code>prefix</code> function.</p><p>The way to deal with this follows on from the previous discussion. Specifically, we said that:</p><blockquote><p>[...] as long as prefixing is implemented by applying a <code>PrefixContext</code> on the outermost layer of the <em>inner</em> model context, this will be correctly combined [...]</p></blockquote><p>When automatic prefixing is used, this application of <code>PrefixContext</code> occurs inside the <code>tilde_assume!!</code> method. In the manual prefixing case, we need to make sure that <code>prefix(submodel::Model, ::Symbol)</code> does the same thing, i.e. it inserts a <code>PrefixContext</code> at the outermost layer of <code>submodel</code>&#39;s context. We can see that this is precisely what happens:</p><pre><code class="language-julia hljs">@model f() = x ~ Normal()

model = f()
prefixed_model = prefix(model, :a)

(model.context, prefixed_model.context)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(DefaultContext(), PrefixContext{VarName{:a, typeof(identity)}, DefaultContext}(a, DefaultContext()))</code></pre><h2 id="Loose-ends-2:-FixedContext"><a class="docs-heading-anchor" href="#Loose-ends-2:-FixedContext">Loose ends 2: FixedContext</a><a id="Loose-ends-2:-FixedContext-1"></a><a class="docs-heading-anchor-permalink" href="#Loose-ends-2:-FixedContext" title="Permalink"></a></h2><p>Finally, note that all of the above also applies to the interaction between <code>PrefixContext</code> and <code>FixedContext</code>, except that the functions have different names. (<code>FixedContext</code> behaves the same way as <code>ConditionContext</code>, except that unlike conditioned variables, fixed variables do not contribute to the log probability density.) This generally results in a large amount of code duplication, but the concepts that underlie both contexts are exactly the same.</p><script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
mermaid.initialize({
    startOnLoad: true,
    theme: "neutral"
});
</script></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../varinfo/">« Design of <code>VarInfo</code></a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.4 on <span class="colophon-date" title="Friday 23 May 2025 15:49">Friday 23 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
